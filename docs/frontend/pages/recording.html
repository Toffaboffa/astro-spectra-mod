<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-translate="recording-title">Recording</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../styles/mod-panels.css">
  <link rel="stylesheet" href="../styles/overlays.css">
  <link rel="stylesheet" href="../styles/mobile-tweaks.css">

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script> <!-- xlsx -->
  <script src="../scripts/mod/coreHooks.js"></script>

  <script src="../scripts/polynomialRegressionScript.js"></script>
  <script src="../scripts/zipScript.js"></script>
  <script src="../scripts/languageScript.js"></script>
  <script src="../scripts/dataSavingScript.js"></script>
  <script src="../scripts/referenceGraphScript.js"></script>
  <script src="../scripts/imageLoadingScript.js"></script>

</head>
<body>

<!-- Recording -->
<div class="container-fluid p-0">
  <div id="appContainer" class="d-flex flex-row min-vh-100 w-100">

    <div id="sidebar-left" class="sidebar bg-sidebar">

      <div id="cameraMainWindow" class="text-center" >

        <div id="videoMainWindow" class="position-relative w-100">
          <video id="videoMain" class="w-100 h-auto" autoplay playsinline></video>
          <img id="cameraImage" class="w-100 h-auto" style="display: none">

          <canvas data-translate="canvas-warning" id="cameraWindowCanvasRecording" class="position-absolute top-0 start-0 w-100 h-auto">Your browser does not support the HTML canvas tag.</canvas>
        </div>

      </div>

      <div id="cameraSettings"
           class="flex-column h-100"
           style="display:flex; flex-grow: 1;">

        <div id="cameraSettingsWindow" class="d-flex flex-column h-100">

          <div id="cameraImageSourceName" class="p-2 w-100">
            <select id="cameraSelect" class="form-select form-select-sm" data-translate-title="camera-select-tooltip"></select>
            <div id="loadedImageFilename" data-translate-title="loaded-image-filename-tooltip" style="display: none"></div>
          </div>

          <div id="cameraImageSourceControlButtons"
               class="d-flex flex-row flex-wrap justify-content-center gap-1">

            <button class="btn btn-sm btn-secondary p-1" onclick="getCameras()" data-translate="refresh-button" data-translate-title="refresh-button-tooltip">Refresh</button>

            <div style="position: relative; width: 80px; height: 30px;">
              <button id="pauseVideoButton"
                      class="btn btn-sm btn-secondary position-absolute top-0 start-0 w-100 h-100 p-1"
                      onclick="pauseVideo()"
                      data-translate="pause-button"
                      data-translate-title="pause-button-tooltip">Pause</button>

              <button id="playVideoButton"
                      class="btn btn-sm btn-secondary position-absolute top-0 start-0 w-100 h-100 p-1"
                      style="visibility: hidden;"
                      onclick="playVideo()"
                      data-translate="play-button"
                      data-translate-title="play-button-tooltip">Play</button>
            </div>

            <button class="btn btn-sm btn-secondary p-1"
                    onclick="loadImageIntoCamera()"
                    data-translate="load-image"
                    data-translate-title="load-image-tooltip">Load Image</button>

            <div style="position: relative; width: 140px; height: 30px;">
              <button id="loadMultipleImagesButton"
                      class="btn btn-sm btn-secondary position-absolute top-0 start-0 w-100 h-100 p-1"
                      onclick="loadMultipleImages()"
                      data-translate="compare-multiple-images-button"
                      data-translate-title="compare-multiple-images-button-tooltip">Compare images</button>

              <button id="removeMultipleImagesButton"
                      class="btn btn-sm btn-secondary position-absolute top-0 start-0 w-100 h-100 p-1"
                      style="visibility: hidden;"
                      onclick="removeLoadedImages()"
                      data-translate="stop-comparison-button"
                      data-translate-title="stop-comparison-button-tooltip">Stop comparison</button>
            </div>
          </div>

          <div id="miscMeasuringSettings" class="flex-grow-1 overflow-auto p-2">
            <!-- Stripe Width -->
            <div id="stripeWidth" class="mb-2 mx-2 small">
              <label for="stripeWidthRange" class="form-label m-0 text-center w-100">
                <span data-translate="stripe-width">Stripe Width</span>
              </label>
              <div class="d-flex align-items-center flex-nowrap gap-1 w-100">
                <button class="btn btn-sm btn-spectraGreen btn-secondary px-2"
                        onclick="changeStripeWidth(-1)"
                        data-translate-title="stripe-width-minus-tooltip">-</button>
                <input type="range" class="form-range flex-grow-1" id="stripeWidthRange" min="1" value="1"
                       onchange="changeStripeWidth(0)"
                       oninput="changeStripeLabels(this.value)"
                       data-translate-title="stripe-width-range-tooltip">
                <button class="btn btn-sm btn-spectraGreen btn-secondary px-2"
                        onclick="changeStripeWidth(1)"
                        data-translate-title="stripe-width-plus-tooltip">+</button>
              </div>
              <div class="text-center">
                <span id="stripeWidthValue">1</span> px
              </div>
            </div>

            <!-- Stripe Placement -->
            <div id="stripePlacement" class="mb-2 mx-2 small">
              <label for="stripePlacementRange" class="form-label m-0 text-center w-100">
                <span data-translate="stripe-place">Stripe Place</span>
              </label>
              <div class="d-flex align-items-center flex-nowrap gap-1 w-100">
                <button class="btn btn-sm btn-spectraGreen btn-secondary px-2"
                        onclick="changeStripePlacement(-1)"
                        data-translate-title="stripe-place-minus-tooltip">-</button>
                <input type="range" class="form-range flex-grow-1" id="stripePlacementRange" min="1"
                       onchange="changeStripePlacement(0)"
                       oninput="changeStripePlacementLabel(this.value)"
                       data-translate-title="stripe-place-range-tooltip">
                <button class="btn btn-sm btn-spectraGreen btn-secondary px-2"
                        onclick="changeStripePlacement(1)"
                        data-translate-title="stripe-place-plus-tooltip">+</button>
              </div>
              <div class="text-center">
                <span id="stripePlacementValue">1</span> px
              </div>
            </div>

            <!-- Exposure -->
            <div id="cameraExposure" class="mb-2 mx-2 small">
              <label for="exposure" class="form-label m-0 text-center w-100" data-translate="adjust-exposure">Adjust Exposure:</label>
              <input id="exposure" type="range" class="form-range"
                     oninput="updateExposureValue(this.value)"
                     data-translate-title="exposure-range-tooltip">
              <div class="text-center">
                <span id="exposureValue">0</span>
              </div>
            </div>

            <div id="referenceGraph" class="p-2">
              <div class="form-check mb-2">
                <input type="checkbox" data-translate-title="reference-graph-checkbox-tooltip" class="form-check-input" id="referenceGraphCheckbox">
                <label class="form-check-label" for="referenceGraphCheckbox" data-translate="reference-graph">
                  Reference Graph
                </label>
              </div>

              <div id="referenceGraphControl" style="display: none;">
                <div class="d-flex flex-wrap gap-2 mb-2">
                  <button class="btn btn-secondary btn-sm"
                          data-translate="add-reference"
                          data-translate-title="reference-graph-add-tooltip"
                          onclick="addReferenceLine()">
                    Add Reference
                  </button>
                  <button class="btn btn-secondary btn-sm"
                          data-translate="reference-from-file"
                          data-translate-title="reference-graph-add-excel-tooltip"
                          onclick="addReferenceLineFromExcel()">
                    Add Reference from File
                  </button>
                  <button class="btn btn-secondary btn-sm"
                          data-translate="reset-references"
                          data-translate-title="reference-graph-reset-tooltip"
                          onclick="removeReferenceLinesAndAddNewReferenceLine()">
                    Reset References
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="cameraSettingsNavButtons"
               class="p-2 d-flex flex-column gap-2 w-100">

            <div class="d-flex flex-row gap-2 w-100">
              <button class="btn btn-md btn-spectraGreen text-white p-1 flex-fill"
                      data-translate="save-data"
                      data-translate-title="save-data-tooltip"
                      onclick="saveRecordingData()">Save data</button>
              <button class="btn btn-md btn-spectraGreen text-white p-1 flex-fill"
                      data-translate="calibrate-button"
                      data-translate-title="calibrate-button-tooltip"
                      onclick="changeSettingsScreen('Calibration')">Calibrate</button>
            </div>

            <button class="btn btn-md btn-spectraGreen text-white p-1 w-100"
                    data-translate="FLR-button"
                    data-translate-title="FLR-button-tooltip"
                    onclick="changeSettingsScreen('LongExpo')">Long Exposure</button>

          </div>


        </div>
      </div>

      <div id="calibrationSettings"
           class="p-2 flex-column gap-2 h-100"
           style="display: none; flex-grow: 1;">

        <!-- Export field + Export button -->
        <div class="d-flex gap-2">
          <input type="text" class="form-control form-control-sm"
                 id="exportCalibrationNameInput"
                 placeholder="Enter filename"
                 data-translate-placeholder="calibration-export-filename-placeholder"
                 data-translate-title="calibration-export-filename-tooltip">
          <button class="btn btn-sm text-light bg-secondary"
                  id="exportCalibrationSettings"
                  data-translate="export-button"
                  data-translate-title="export-button-tooltip"
                  onclick="exportCalibrationFile()">Export calibration settings</button>
        </div>

        <!-- Import input -->
        <input type="file" name="my_file" id="my-file" accept=".txt"
               class="form-control form-control-sm"
               data-translate-title="import-calibration-file-tooltip"
               onclick="this.value=null"
               onchange="importCalibrationFile()">

        <!-- Input wrapper -->
        <div id="input-wrapper" class="flex-grow-1 d-flex flex-column">
          <div id="input-header">
            <div>px</div>
            <div>nm</div>
          </div>
          <div id="input-container"></div>
        </div>

        <!-- Add + Reset buttons -->
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-secondary flex-fill p-1"
                  id="addPoints"
                  data-translate="addCalPoints-button"
                  data-translate-title="addCalPoints-button-tooltip"
                  onclick="addInputPair()">Add</button>
          <button class="btn btn-sm btn-secondary flex-fill p-1"
                  id="resetCalibrationPoints"
                  data-translate="reset-button"
                  data-translate-title="reset-button-tooltip"
                  onclick="resetCalibrationPoints()">Reset</button>
          <button class="btn btn-sm btn-secondary flex-fill p-1"
                  id="orderCalibrationPoints"
                  data-translate="sortCalPoints-button"
                  data-translate-title="sortCalPoints-button-tooltip"
                  onclick="sortCalibrationInputPairs()">Sort</button>
        </div>

      <div class="pv-1">
        <button class="btn btn-md btn-spectraGreen text-white p-1 w-100 mt-auto"
                data-translate="measuring-button"
                data-translate-title="camera-button-tooltip"
                onclick="changeSettingsScreen('Graph')"
                >Record</button>
      </div>

      </div>

      <div id="cameraExposureWindow" class="p-2"
           style="display: none; max-width: 400px; height: 100%;">

        <div class="flex-grow-1 overflow-auto" style="min-height: 0;">
          <div class="mb-3">
            <label for="NumOfSamples" class="form-label">
              <span data-translate="FLR-captures-count">Number of Captures</span>
            </label>
            <input type="number" class="form-control form-control-sm"
                   id="NumOfSamples" name="NumOfSamples" min="1" value="5"
                   data-translate-title="FLR-captures-count-input-tooltip">
          </div>

          <div class="mb-3">
            <label for="timeOfPause" class="form-label">
              <span data-translate="FLR-captures-pause">Pause in between captures</span>
            </label>
            <div class="input-group input-group-sm">
              <input type="number" class="form-control"
                     id="timeOfPause" name="timeOfPause" min="200" value="300"
                     data-translate-title="FLR-captures-pause-input-tooltip">
              <span class="input-group-text" data-translate="in-ms">(in ms.)</span>
            </div>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input"
                   id="screenshotOfGraph" name="screenshotOfGraph"
                   data-translate-title="FLR-screenshot-graph-tooltip">
            <label class="form-check-label" for="screenshotOfGraph" data-translate="FLR-screenshot-graph">
              Screenshot Graph
            </label>
          </div>

          <button class="btn btn-secondary btn-sm mb-3"
                  data-translate="FLR-capture-button"
                  data-translate-title="FLR-capture-button-tooltip"
                  onclick="startCameraCapture()">Capture</button>
        </div>

        <div class="d-flex flex-row gap-2 w-100">
          <button class="btn btn-md btn-spectraGreen text-white p-1 flex-fill"
                  data-translate="measuring-button"
                  data-translate-title="camera-button-tooltip"
                  onclick="changeSettingsScreen('Graph')">Record</button>

          <button class="btn btn-md btn-spectraGreen text-white p-1 flex-fill"
                  data-translate="calibrate-button"
                  data-translate-title="calibrate-button-tooltip"
                  onclick="changeSettingsScreen('Calibration')">Calibrate</button>
        </div>
      </div>

    </div>

    <div id="sidebarHoverZoneLeft" class="moved"></div>
    <div id="sidebarToggleHandleLeft" class="sidebar-handle-vertical moved" onclick="changeDisplayScreen('settings')">
      ◁
    </div>

    <div id="mainContent" class="main-content flex-grow-1 bg-mainContent">

      <!-- Graph -->
      <div id="graphWindowContainer">
        <div id="graphWindow">
          <div id="graphCanvasWindow">
            <div class="ParentElement">
              <div id="blackBox"></div>
              <canvas id="stripeCanvas"></canvas>
            </div>
            <canvas id="graphCanvas" class="withDrawer"></canvas>
            <script src="../scripts/graphScript.js"></script>
          </div>

        </div>
      </div>

      <div id="calibrationWindowContainer" style="display: none">
        <div id="graphWindowCalibration" class="w-100">
          <canvas id="graphCalibration"></canvas>
          <canvas id="graphDivergence"></canvas>
        </div>
      </div>

      <div id="graphSettingsDrawer">

        <div id="graphSettingsDrawerLeft">
          <div class="d-flex flex-wrap gap-2 align-items-center p-2">
            <button class="btn btn-secondary btn-sm"
                    data-translate="reset-zoom"
                    data-translate-title="reset-zoom-tooltip"
                    id="resetZoomButton">Reset Zoom</button>
            <button class="btn btn-secondary btn-sm"
                    id="stepBackButton"
                    data-translate="zoom-step-back"
                    data-translate-title="zoom-step-back-tooltip">Step Back</button>
            <button class="btn btn-secondary btn-sm"
                    id="stepLeftButton"
                    disabled
                    data-translate-title="zoom-step-left-tooltip">←</button>
            <button class="btn btn-secondary btn-sm"
                    id="stepRightButton"
                    disabled
                    data-translate-title="zoom-step-right-tooltip">→</button>
            <input class="form-range darker-slider w-auto" type="range" id="zoomScroller" min="0" max="100" value="0" disabled />

            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="radio"
                     id="toggleXLabelsPx" name="toggleXLabels"
                     value="px" checked
                     data-translate-title="X-px-tooltip">
              <label class="form-check-label" for="toggleXLabelsPx">
                <span data-translate="X-px">X-axis Labels (px)</span>
              </label>
            </div>

            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="radio"
                     id="toggleXLabelsNm" name="toggleXLabels" value="nm"
                     data-translate-title="X-nm-tooltip">
              <label class="form-check-label" for="toggleXLabelsNm">
                <span data-translate="X-nm">X-axis Labels (nm)</span>
              </label>
            </div>

            <div id="mouseCoordinates">X: N/A, Y: N/A</div>
          </div>

          <div class="d-flex flex-row flex-wrap gap-4 px-2">

            <!-- Combined/R/G/B stacked -->
            <div class="d-flex flex-column gap-1">
              <div class="form-check">
                <input class="form-check-input" type="checkbox"
                       id="toggleCombined" checked
                       data-translate-title="combined-graph-tooltip">
                <label class="form-check-label" data-translate="combined-graph" for="toggleCombined">Combined</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="toggleR"
                       data-translate-title="Red-graph-tooltip">
                <label class="form-check-label" for="toggleR">R</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="toggleG"
                       data-translate-title="Green-graph-tooltip">
                <label class="form-check-label" for="toggleG">G</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="toggleB"
                       data-translate-title="Blue-graph-tooltip">
                <label class="form-check-label" for="toggleB">B</label>
              </div>
            </div>

            <!-- Color Graph + Opacity -->
            <div class="d-flex flex-column gap-2 align-self-center">
              <div class="form-check">
                <input class="form-check-input" data-translate-title="fill-graph-tooltip" type="checkbox" id="colorGraph">
                <label class="form-check-label" data-translate="fill-graph" for="colorGraph">Color the Graph</label>
              </div>
              <div id="gradientOpacitySliderContainer" style="display: none;" class="d-flex align-items-center gap-2">
                <label for="gradientOpacitySlider" data-translate="fill-opacity" class="form-label mb-0">Color Opacity</label>
                <input type="range" class="form-range darker-slider w-auto"
                       style="width: 150px;" id="gradientOpacitySlider"
                       min="0.1" max="1" step="0.1" value="0.7"
                       data-translate-title="fill-opacity-tooltip">
                <span id="gradientOpacityValue">0.7</span>
              </div>
            </div>

            <!-- Toggle Peaks + Min Value -->
            <div class="d-flex flex-column gap-2 align-self-center">
              <div class="form-check">
                <input class="form-check-input" data-translate-title="toggle-peaks-tooltip" type="checkbox" id="togglePeaksCheckbox">
                <label class="form-check-label" data-translate="toggle-peaks" for="togglePeaksCheckbox">Toggle Peaks</label>
              </div>
              <div class="d-flex align-items-center gap-2">
                <label for="peakSizeLower" class="form-label mb-0" data-translate="lower-bound">Lower bound</label>
                <input type="number" id="peakSizeLower"
                       value="1" min="1" max="255" style="width:60px;"
                       data-translate-title="lower-bound-tooltip">
              </div>
            </div>
          </div>
        </div>

        <div id="graphSettingsDrawerRight">

          <div id="drawerCollapseButton" class="sidebar-handle-horizontal"
               data-translate-title="collapse-button-tooltip"
               onclick="changeDisplayScreen('drawer')">▽</div>

        </div>
      </div>

      <div id="drawerHoverZone" class="disabled"></div>
      <div id="drawerExpandButton"
           class="sidebar-handle-horizontal disabled"
           onclick="changeDisplayScreen('drawer')">△</div>

    </div>

    <div id="sidebar-right" class="sidebar bg-sidebar hidden">
      <div class="image-loaded-wrapper small-camera-image-entry">
        <div class="image-controls">
          <input type="radio" id="imageRadio0"
                 data-translate-title="image-from-camera-tooltip"
                 onclick="checkRadio(0)" checked/>
        </div>
        <div class="camera-image-text">
          <span data-translate="image-from-Camera">Camera image</span>
        </div>
      </div>
    </div>

    <div id="sidebarHoverZoneRight"></div>
    <div id="sidebarToggleHandleRight" class="sidebar-handle-vertical" onclick="changeDisplayScreen('imgSelect')">
      ◁
    </div>

    <div id="infoPopupBlock"></div>

    <div id="cameraRecordingIsOn" class="recording-toast">
      <div id="cameraRecordingIsOnWindows" class="container-sm bg-dark text-white rounded px-4 py-2 shadow">
        <span data-translate="recording-screenshots" class="mt-1">Recording screenshots...</span>
        <button class="btn btn-sm btn-light ms-3"
                data-translate="FLR-cancel-button"
                data-translate-title="FLR-cancel-button-tooltip"
                onclick="stopOngoingRecording()">Cancel</button>
      </div>
    </div>

    <div id="infoPopup" class="recording-toast">
      <div id="infoPopupInside" class="container-sm bg-dark text-white rounded px-4 py-2 shadow">
        <span id="infoPopupMessage" data-translate="" class="mt-1">Info message</span>
        <div id="infoPopupButtonContainer">
          <button id="infoPopupButton" class="btn btn-sm btn-light ms-3" data-translate="" onclick="closeInfoPopup()">Cancel</button>
        </div>
      </div>
    </div>

    <div id="errorBlock"></div>

    <div id="errorBox" class="recording-toast">
      <div id="errorBoxInside" class="container-sm bg-danger text-white rounded px-4 py-2 shadow">
        <span id="errorMessage" data-translate="" class="mt-1">Error message</span>
        <button class="btn btn-sm btn-light m-1" data-translate="acknowledge" onclick="uncallError()">I understand</button>
      </div>
    </div>

  </div>
</div>

<script src="../scripts/setupScript.js"></script>
<script src="../scripts/cameraScript.js"></script>
<script src="../scripts/stripeScript.js"></script>
<script src="../scripts/cameraSelection.js"></script>
<script src="../scripts/calibrationScript.js"></script>
<script>resetCamera();</script>


  <!-- SPECTRA-PRO Phase 0 bridge (non-invasive) -->
  <script src="../scripts/mod/eventBus.js"></script>
  <script src="../scripts/mod/stateStore.js"></script>
  <script src="../scripts/mod/appMode.js"></script>
  <script src="../scripts/mod/uiPanels.js"></script>
  <script src="../scripts/mod/spectrumFrameAdapter.js"></script>
  <script src="../scripts/mod/overlays.js"></script>
  <script src="../scripts/mod/analysisWorkerClient.js"></script>
  <script>
  (function(){
    const sp = window.SpectraPro || (window.SpectraPro = {});
    if (!sp.coreHooks) return;
    // Phase 1 keeps this bridge tiny; UI + worker wiring lives in mod/proBootstrap.js
    function safeUpdate(path, value, source){ if (sp.store && sp.store.update) sp.store.update(path, value, { source: source || 'phase1-bridge' }); }
    sp.coreHooks.on('calibrationChanged', function(cal){ safeUpdate('calibration', Object.assign({}, (sp.store?.getState?.().calibration||{}), cal||{})); });
    sp.coreHooks.on('referenceChanged', function(ref){ if (sp.coreBridge) sp.coreBridge.reference = Object.assign({}, sp.coreBridge.reference||{}, ref||{}); });
  })();
  </script>
  <script src="../scripts/mod/proBootstrap.js"></script>

</body>
</html>
