name: CI

on:
  push:
  pull_request:

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Backend smoke / tests (skip if no backend)
        shell: bash
        run: |
          set -e
          if [ ! -d backend ]; then
            echo "No backend/ directory yet. Skipping backend-tests."
            exit 0
          fi
          cd backend
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pytest.ini ] || [ -d tests ]; then pytest -q; else echo "No backend tests found."; fi

  frontend-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate script/style paths
        run: |
          set -e
          if grep -n "\.\./components/" docs/frontend/pages/recording.html; then
            echo "recording.html still references ../components/. Use ../scripts/." >&2
            exit 1
          fi
          # Validate linked local assets in recording.html instead of hardcoded legacy filenames
          python3 - <<'PYCHK'
          from pathlib import Path
          import re, sys
          html_path = Path('docs/frontend/pages/recording.html')
          html = html_path.read_text(encoding='utf-8', errors='ignore')
          refs = re.findall(r"(?:href|src)=[\"']([^\"']+)[\"']", html, flags=re.I)
          missing = []
          for ref in refs:
              if ref.startswith(('http://','https://','//','data:','#')):
                  continue
              target = (html_path.parent / ref).resolve()
              if not target.exists():
                  missing.append(ref)
          if missing:
              print('Missing local references in recording.html:', ', '.join(sorted(set(missing))), file=sys.stderr)
              sys.exit(1)
          print('recording.html path check OK')
          PYCHK